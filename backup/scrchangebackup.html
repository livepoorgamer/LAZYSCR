<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SCR Change Message Requests</title>
  <!-- Google Fonts for 'Orbitron' and 'Roboto Mono' -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono&display=swap" rel="stylesheet">
  <style>
    /* ----------------------------
       BASIC STYLING
    ----------------------------- */
    body {
      /* Futuristic, gradient background */
      background: linear-gradient(135deg, #131313 0%, #323232 100%);
      margin: 0;
      padding: 0;
      font-family: 'Roboto Mono', monospace; /* Default font */
      color: #fff; /* White text on dark background */
    }

    /* Smooth transitions for hover effects, etc. */
    * {
      transition: all 0.2s ease-in-out;
    }

    /* ----------------------------
       NAVIGATION STYLING
    ----------------------------- */
    nav {
      background: #1B1B1B; /* Dark nav bar */
      padding: 10px 20px;
      border-bottom: 2px solid #00FFD1; /* A futuristic accent color */
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
    }
    nav ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: flex-start;
      align-items: center;
    }
    nav li {
      margin-right: 20px;
    }
    nav a {
      color: #fff;
      text-decoration: none;
      font-size: 16px;
      font-family: 'Orbitron', sans-serif;
      text-transform: uppercase;
    }
    nav a:hover {
      color: #00FFD1;
      text-shadow: 0 0 5px #00FFD1;
    }

    /* ----------------------------
       CONTAINER STYLING
    ----------------------------- */
    .container {
      max-width: 900px;
      margin: 40px auto; 
      padding: 20px;
      background: #1F1F1F;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0, 255, 209, 0.2); /* Slight neon glow */
    }
    .container h1 {
      text-transform: uppercase;
      text-align: center;
      color: #00FFD1;
      text-shadow: 0 0 8px rgba(0, 255, 209, 0.7);
      margin-top: 0;
      margin-bottom: 20px;
      font-family: 'Orbitron', sans-serif;
      font-size: 2rem;
    }
    .container h2 {
      color: #00FFD1;
      text-shadow: 0 0 5px rgba(0, 255, 209, 0.7);
      margin-bottom: 20px;
      font-family: 'Orbitron', sans-serif;
      font-size: 1.2rem;
      text-transform: uppercase;
    }

    /* ----------------------------
       FORMS STYLING
    ----------------------------- */
    form {
      margin-bottom: 20px;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 200px;
    }

    .form-group label {
      margin-bottom: 5px;
      font-size: 0.85rem;
      font-family: 'Orbitron', sans-serif;
      color: #00FFD1;
    }

    .form-group input,
    .form-group select {
      padding: 10px;
      background: #2E2E2E;
      color: #FFF;
      border: 1px solid #444;
      border-radius: 4px;
      font-family: 'Roboto Mono', monospace;
      font-size: 14px;
      outline: none;
      resize: vertical;
    }

    .form-group input::placeholder, 
    .form-group select::placeholder {
      color: #aaa;
    }

    /* ----------------------------
       BUTTONS STYLING
    ----------------------------- */
    .button-container {
      text-align: center;
      margin: 20px 0;
    }

    .btn {
      padding: 10px 20px;
      margin: 5px 10px 5px 0;
      background: linear-gradient(90deg, #00FFD1 0%, #007BFF 100%);
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      text-transform: uppercase;
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
      box-shadow: 0 0 10px rgba(0, 255, 209, 0);
    }
    .btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 10px rgba(0, 255, 209, 0.7);
    }

    /* ----------------------------
       OUTPUT CONTAINER
    ----------------------------- */
    .output-container {
      margin-top: 20px;
      padding: 20px;
      background: #101010;
      border: 1px dashed #00FFD1;
      border-radius: 4px;
      white-space: pre-wrap;
      font-family: 'Roboto Mono', monospace;
      color: #00FFD1;
      line-height: 1.5;
    }
    .output-container .heading {
      text-transform: uppercase;
      margin-bottom: 10px;
      color: #00FFD1;
      font-family: 'Orbitron', sans-serif;
      font-size: 1.1rem;
    }

    /* ----------------------------
       HIDDEN CONTAINERS
    ----------------------------- */
    #departureContainer,
    #arrivalContainer {
      display: none;
    }

    /* ----------------------------
       SCR MESSAGE STYLING
    ----------------------------- */
    .scr-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .scr-info-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .airport-code {
      font-weight: bold;
      font-size: 1rem;
      font-family: 'Orbitron', sans-serif;
    }

    .button-group {
      display: flex;
      gap: 5px;
    }

    .button-group button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      text-transform: uppercase;
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
    }
    .email-btn {
      background: linear-gradient(90deg, #00FFD1 0%, #007BFF 100%);
      color: #fff;
      box-shadow: 0 0 10px rgba(0, 255, 209, 0);
    }
    .email-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 10px rgba(0, 255, 209, 0.7);
    }
    .toggle-btn {
      background: #555;
      color: #fff;
      width: 40px;
      text-align: center;
      padding: 8px;
      box-shadow: 0 0 5px rgba(0, 255, 209, 0);
    }
    .toggle-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 10px rgba(0, 255, 209, 0.7);
    }

    .scr-message {
      margin-top: 10px;
      padding: 15px;
      background: #1E1E1E;
      border-left: 4px solid #00FFD1;
      border-radius: 4px;
      white-space: pre-wrap;
      font-family: 'Roboto Mono', monospace;
      color: #00FFD1;
    }
  </style>
</head>
<body>

  <!-- Navigation Bar -->
  <nav>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="historic-log.html">Historic Log</a></li>
      <li><a href="airport-search.html">Airport Search</a></li>
      <li><a href="https://forms.gle/nXCQzWxCcH5B1uZd6">LOG ISSUES</a></li>
      <!-- Add more navigation items here if needed -->
    </ul>
  </nav>

  <!-- Main Container -->
  <div class="container">
    <h1>SCR Change Message Requests</h1>

    <!-- Where all pairs of forms will be placed -->
    <div id="formsWrapper"></div>

    <!-- Button container for adding more / resetting / showing message -->
    <div class="button-container">
      <button class="btn" id="addFormsBtn">Add More Requests</button>
      <button class="btn" id="resetBtn">Reset</button>
      <button class="btn" id="showSCRBtn">Show SCR Messages</button>
    </div>

    <!-- Container to hold the SCR messages -->
    <div id="outputList" class="output-container">
      <div class="heading">SCR Messages</div>
      <!-- SCR messages will be appended here -->
    </div>
  </div>

  <!-- Hidden template that contains one “pair” of forms -->
  <template id="formsTemplate">
    <div class="requests-container">
      <h2>Request #</h2> <!-- We'll set the request number dynamically -->

      <h2>Old Request</h2>
      <form class="old-request-form">
        <div class="form-row">
          <div class="form-group">
            <label>Slot</label>
            <select required name="slotType">
              <option value="" disabled selected>-</option>
              <option value="Arrival">Arrival</option>
              <option value="Departure">Departure</option>
            </select>
          </div>
          <div class="form-group">
            <label>Airport</label>
            <input type="text" name="airport" placeholder="DUB">
          </div>
          <div class="form-group">
            <label>Flight</label>
            <input type="text" name="flightNo" placeholder="FR123">
          </div>
          <div class="form-group">
            <label>Date</label>
            <input type="date" name="date">
          </div>
          <div class="form-group">
            <label>Seats</label>
            <input type="number" name="seats" placeholder="189">
          </div>
          <div class="form-group">
            <label>A/C</label>
            <input type="text" name="acType" placeholder="73H">
          </div>
          <div class="form-group">
            <label>Time</label>
            <input type="text" name="time" placeholder="2000">
          </div>
          <div class="form-group">
            <label>D/O</label>
            <input type="text" name="do" placeholder="STN">
          </div>
          <div class="form-group">
            <label>STC</label>
            <select required name="stc">
              <option value="" disabled selected>-</option>
              <option value="P">P</option>
              <option value="D">D</option>
              <option value="T">T</option>
              <option value="K">K</option>
              <option value="J">J</option>
              <option value="X">X</option>  
            </select>
          </div>
        </div>
      </form>

      <h2>New Request</h2>
      <form class="new-request-form">
        <div class="form-row">
          <div class="form-group">
            <label>Slot</label>
            <select required name="slotType">
              <option value="" disabled selected>-</option>
              <option value="Arrival">Arrival</option>
              <option value="Departure">Departure</option>
            </select>
          </div>
          <div class="form-group">
            <label>Airport</label>
            <input type="text" name="airport" placeholder="DUB">
          </div>
          <div class="form-group">
            <label>Flight</label>
            <input type="text" name="flightNo" placeholder="FR123">
          </div>
          <div class="form-group">
            <label>Date</label>
            <input type="date" name="date">
          </div>
          <div class="form-group">
            <label>Seats</label>
            <input type="number" name="seats" placeholder="189">
          </div>
          <div class="form-group">
            <label>A/C</label>
            <input type="text" name="acType" placeholder="73H">
          </div>
          <div class="form-group">
            <label>Time</label>
            <input type="text" name="time" placeholder="2100">
          </div>
          <div class="form-group">
            <label>D/O</label>
            <input type="text" name="do" placeholder="STN">
          </div>
          <div class="form-group">
            <label>STC</label>
            <select required name="stc">
              <option value="" disabled selected>-</option>
              <option value="P">P</option>
              <option value="D">D</option>
              <option value="T">T</option>
              <option value="K">K</option>
              <option value="J">J</option>
            </select>
          </div>
        </div>
      </form>
    </div>
  </template>

  <script>
    const formsWrapper  = document.getElementById('formsWrapper');
    const addFormsBtn   = document.getElementById('addFormsBtn');
    const resetBtn      = document.getElementById('resetBtn');
    const showSCRBtn    = document.getElementById('showSCRBtn');
    const formsTemplate = document.getElementById('formsTemplate');
    const outputList    = document.getElementById('outputList');

    // Dictionary of day-of-operation codes
    const dayOfOperationMap = {
      0: '0000007', // Sunday
      1: '1000000', // Monday
      2: '0200000', // Tuesday
      3: '0030000', // Wednesday
      4: '0004000', // Thursday
      5: '0000500', // Friday
      6: '0000060', // Saturday
    };

    let requestCount = 0; 
    let emailData = {}; // To store emails fetched from emails.json

    // On page load, add the first pair and fetch emails.json
    window.addEventListener('DOMContentLoaded', () => {
      addFormsPair();
      fetchEmails();
    });

    addFormsBtn.addEventListener('click', addFormsPair);

    resetBtn.addEventListener('click', () => {
      formsWrapper.innerHTML = '';
      outputList.innerHTML   = '<div class="heading">SCR Messages</div>';
      requestCount = 0;
      addFormsPair();
    });

    // Show SCR for each container -> create togglable rows
    showSCRBtn.addEventListener('click', () => {
      // Clear previous output
      outputList.innerHTML = '<div class="heading">SCR Messages</div>';

      const containers = formsWrapper.querySelectorAll('.requests-container');
      if (containers.length === 0) {
        outputList.innerHTML += 'No forms available.';
        return;
      }

      containers.forEach((container) => {
        const oldForm = container.querySelector('.old-request-form');
        const newForm = container.querySelector('.new-request-form');
        if (!oldForm || !newForm) return;

        // Extract data
        const oldData = getFormData(oldForm);
        const newData = getFormData(newForm);

        // Validate required fields
        if (!validateFormData(oldData, newData)) {
          alert('Please fill out all required fields.');
          return;
        }

        // Build SCR
        const scrMessage = buildSCRMessage(oldData, newData);

        // Use Old Request airport for the label
        const airportCode = oldData.airport || '???';

        // Create row + hidden message
        const rowDiv = document.createElement('div');
        rowDiv.classList.add('scr-row');

        const infoLeftDiv = document.createElement('div');
        infoLeftDiv.classList.add('scr-info-left');
        const airportSpan = document.createElement('span');
        airportSpan.classList.add('airport-code');
        airportSpan.textContent = airportCode;
        infoLeftDiv.appendChild(airportSpan);

        const buttonGroup = document.createElement('div');
        buttonGroup.classList.add('button-group');

        const emailBtn = document.createElement('button');
        emailBtn.classList.add('email-btn');
        emailBtn.textContent = 'Email';
        // Updated logic: Open email client directly with CC and subject
        emailBtn.addEventListener('click', () => {
          sendEmail(airportCode, scrMessage);
        });

        const toggleBtn = document.createElement('button');
        toggleBtn.classList.add('toggle-btn');
        toggleBtn.textContent = '+';

        // The hidden message
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('scr-message');
        msgDiv.textContent = scrMessage;

        // Toggle show/hide
        toggleBtn.addEventListener('click', () => {
          if (msgDiv.style.display === 'none' || !msgDiv.style.display) {
            msgDiv.style.display = 'block';
            toggleBtn.textContent = '-';
          } else {
            msgDiv.style.display = 'none';
            toggleBtn.textContent = '+';
          }
        });

        buttonGroup.appendChild(emailBtn);
        buttonGroup.appendChild(toggleBtn);

        rowDiv.appendChild(infoLeftDiv);
        rowDiv.appendChild(buttonGroup);

        outputList.appendChild(rowDiv);
        outputList.appendChild(msgDiv);
      });
    });

    /** Adds a new pair of forms. Also sets a "Request #n" heading 
        and ensures text inputs become uppercase. */
    function addFormsPair() {
      requestCount++;
      const clone = formsTemplate.content.cloneNode(true);
      
      // Title
      const heading = clone.querySelector('h2');
      if (heading) {
        heading.textContent = `Request #${requestCount}`;
      }

      // Enforce uppercase for text inputs
      const textInputs = clone.querySelectorAll('input[type="text"]');
      textInputs.forEach(input => {
        // Force actual value to uppercase
        input.addEventListener('input', () => {
          input.value = input.value.toUpperCase();
        });
      });

      // Synchronize Slot Type between Old and New Request
      const oldSlotTypeSelect = clone.querySelector('.old-request-form select[name="slotType"]');
      const newSlotTypeSelect = clone.querySelector('.new-request-form select[name="slotType"]');

      if (oldSlotTypeSelect && newSlotTypeSelect) {
        // Set initial value of New Request SlotType to match Old Request
        newSlotTypeSelect.value = oldSlotTypeSelect.value;

        // Add event listener to Old Request SlotType
        oldSlotTypeSelect.addEventListener('change', (event) => {
          newSlotTypeSelect.value = event.target.value;
        });
      }

      formsWrapper.appendChild(clone);
    }

    /** Gather data from forms */
    function getFormData(formEl) {
      const slotType = formEl.querySelector('select[name="slotType"]')?.value || '';
      const airport  = formEl.querySelector('input[name="airport"]')?.value || '';
      const flightNo = formEl.querySelector('input[name="flightNo"]')?.value || '';
      const date     = formEl.querySelector('input[name="date"]')?.value || '';
      const seats    = formEl.querySelector('input[name="seats"]')?.value || '';
      const acType   = formEl.querySelector('input[name="acType"]')?.value || '';
      const time     = formEl.querySelector('input[name="time"]')?.value || '';
      const doField  = formEl.querySelector('input[name="do"]')?.value || '';
      const stc      = formEl.querySelector('select[name="stc"]')?.value || '';

      return { slotType, airport, flightNo, date, seats, acType, time, doField, stc };
    }

    /** Validate that all required fields are filled */
    function validateFormData(oldReq, newReq) {
      // Define required fields as per your application's needs
      const requiredFields = ['slotType', 'airport', 'flightNo', 'date', 'seats', 'acType', 'time', 'doField', 'stc'];
      
      for (let field of requiredFields) {
        if (!oldReq[field] || !newReq[field]) {
          return false;
        }
      }

      return true;
    }

    function buildSCRMessage(oldReq, newReq) {
      const seasonCode      = 'W24'; 
      const oldReqDateDDMMM = formatDateToDDMMM(oldReq.date) || '01JAN';
      const oldReqAirport   = oldReq.airport || 'XXX';

      const lineSCR     = 'SCR';
      const lineSeason  = seasonCode;
      const lineDate    = oldReqDateDDMMM;
      const lineAirport = oldReqAirport;

      const lineOld = buildRequestLine('C', oldReq);
      const lineNew = buildRequestLine('R', newReq);
      const lineSI  = `SI SLOT CHG REQ ${oldReqAirport}`;

      return [
        lineSCR,
        lineSeason,
        lineDate,
        lineAirport,
        lineOld,
        lineNew,
        '',
        lineSI
      ].join('\n');
    }

    function buildRequestLine(prefix, req) {
      // Arrival => no space: e.g. "CFR123"
      // Departure => space: e.g. "C FR123"
      let flightId;
      if (req.slotType === 'Arrival') {
        flightId = prefix + (req.flightNo || '');
      } else {
        flightId = prefix + ' ' + (req.flightNo || '');
      }

      const dateDDMMM  = formatDateToDDMMM(req.date) || '25DEC';
      const doCode     = getDayOfOperationCode(req.date);
      let acTypeCode = '000' + (req.acType.replace(/\s/g, '') || '');

      // If STC is "D", replace "73H" with "LJ4"
      if (req.stc === 'D') {
        acTypeCode = 'LJ4';
      }

      // Arrival => station + time
      // Departure => time + station
      let stationTimeSegment;
      if (req.slotType === 'Arrival') {
        stationTimeSegment = (req.doField || '') + (req.time || '');
      } else {
        stationTimeSegment = (req.time || '') + (req.doField || '');
      }

      return [
        flightId,
        dateDDMMM + dateDDMMM,
        doCode,
        acTypeCode,
        stationTimeSegment,
        req.stc
      ].join(' ');
    }

    function formatDateToDDMMM(isoDate) {
      if (!isoDate) return '';
      const [yyyy, mm, dd] = isoDate.split('-');
      if (!yyyy || !mm || !dd) return '';

      const monthNames = [
        'JAN','FEB','MAR','APR','MAY','JUN',
        'JUL','AUG','SEP','OCT','NOV','DEC'
      ];
      const monthIndex = parseInt(mm, 10) - 1;
      if (monthIndex < 0 || monthIndex > 11) return '';
      return dd + monthNames[monthIndex];
    }

    function getDayOfOperationCode(isoDate) {
      if (!isoDate) return '0000000';
      const jsDate = new Date(isoDate);
      if (isNaN(jsDate.getTime())) return '0000000';

      const dayIndex = jsDate.getDay(); // Sunday=0, ...
      return dayOfOperationMap[dayIndex] || '0000000';
    }

    /** Function to fetch emails from emails.json */
    async function fetchEmails() {
      try {
        const response = await fetch('assets/emails.json');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        emailData = data;
        console.log('Emails fetched successfully:', emailData);
      } catch (error) {
        console.error('Error fetching emails.json:', error);
        alert('Failed to load email data. Email functionality may be limited.');
      }
    }

    /** Function to send email using mailto: link with CC and dynamic subject */
    function sendEmail(airportCode, scrMessage) {
      if (!emailData || !emailData[airportCode] || !emailData[airportCode].email) {
        alert(`No email address found for airport code: ${airportCode}. Please check emails.json.`);
        return;
      }

      const recipient = emailData[airportCode].email;
      const subject = `SLOT CHG REQ ${airportCode}`;
      const body = encodeURIComponent(scrMessage);
      const cc = 'slotdesk@ryanair.com';

      const mailtoLink = `mailto:${recipient}?cc=${encodeURIComponent(cc)}&subject=${encodeURIComponent(subject)}&body=${body}`;

      // Create a temporary anchor element and trigger click
      const a = document.createElement('a');
      a.href = mailtoLink;
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      // Optional: Provide feedback to the user
      alert(`Email client has been opened for ${airportCode}.`);
    }
  </script>
</body>
</html>
