<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SCR Change Message Requests</title>

  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono&display=swap"
    rel="stylesheet"
  >

  <style>
    /********************************************
     1) THEME VARIABLES: Light by default
    ********************************************/
    :root {
      /* Light Theme */
      --body-bg: #f5f5f5;
      --text-color: #333;
      --nav-bg: #fff;
      --nav-text-color: #333;
      --primary-color: #00FFD1;
      --secondary-color: #007BFF;
      --container-bg: #ffffff;
      --border-color: #00FFD1;
      --heading-color: #00FFD1;
      --input-bg: #ffffff;
      --input-border: #cccccc;
      --button-bg-color: linear-gradient(90deg, #00FFD1 0%, #007BFF 100%);
      --button-text-color: #ffffff;
      --output-bg: #ffffff;
      --output-border: #00ffd1;
    }

    /* Dark Theme Override */
    body.dark-mode {
      --body-bg: #1a1a1a;
      --text-color: #eaeaea;
      --nav-bg: #2a2a2a;
      --nav-text-color: #f5f5f5;
      --primary-color: #00ffd1;
      --secondary-color: #007BFF;
      --container-bg: #2f2f2f;
      --border-color: #00ffd1;
      --heading-color: #00ffd1;
      --input-bg: #3a3a3a;
      --input-border: #555555;
      --button-bg-color: linear-gradient(90deg, #00FFD1 0%, #007BFF 100%);
      --button-text-color: #1a1a1a;
      --output-bg: #1a1a1a;
      --output-border: #00ffd1;
    }

    /********************************************
     2) GLOBAL & BODY
    ********************************************/
    * {
      box-sizing: border-box;
      transition: all 0.2s ease-in-out;
    }
    body {
      background: var(--body-bg);
      margin: 0;
      padding: 0;
      font-family: 'Roboto Mono', monospace;
      color: var(--text-color);
    }
    a {
      color: var(--nav-text-color);
      text-decoration: none;
    }
    a:hover {
      color: var(--secondary-color);
    }

    /********************************************
     3) NAVIGATION BAR
    ********************************************/
    nav {
      background: var(--nav-bg);
      color: var(--nav-text-color);
      padding: 10px 20px;
      border-bottom: 2px solid var(--primary-color);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    nav ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
    }
    nav li {
      margin-right: 20px;
    }
    nav a {
      font-size: 16px;
      font-family: 'Orbitron', sans-serif;
      text-transform: uppercase;
      color: var(--nav-text-color);
    }
    nav a:hover {
      color: var(--secondary-color);
      text-shadow: 0 0 5px var(--secondary-color);
    }
    /* Theme Switch */
    .theme-switch {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    .theme-switch input {
      appearance: none;
      width: 40px;
      height: 20px;
      background-color: #ccc;
      border-radius: 20px;
      position: relative;
      outline: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .theme-switch input::before {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      background-color: #fff;
      border-radius: 50%;
      transition: transform 0.3s ease;
    }
    .theme-switch input:checked {
      background-color: var(--secondary-color);
    }
    .theme-switch input:checked::before {
      transform: translateX(20px);
    }

    /********************************************
     4) CONTAINER & HEADINGS
    ********************************************/
    .container {
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: var(--container-bg);
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0, 255, 209, 0.1);
    }
    .container h1 {
      text-transform: uppercase;
      text-align: center;
      color: var(--heading-color);
      margin-top: 0;
      margin-bottom: 20px;
      font-family: 'Orbitron', sans-serif;
      font-size: 2rem;
    }
    .container h2 {
      color: var(--heading-color);
      margin-bottom: 20px;
      font-family: 'Orbitron', sans-serif;
      font-size: 1.2rem;
      text-transform: uppercase;
    }

    /********************************************
     5) FORMS
    ********************************************/
    form {
      margin-bottom: 20px;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 200px;
    }
    .form-group label {
      margin-bottom: 5px;
      font-size: 0.85rem;
      font-family: 'Orbitron', sans-serif;
      color: var(--secondary-color);
    }
    .form-group input,
    .form-group select {
      padding: 10px;
      background: var(--input-bg);
      color: var(--text-color);
      border: 1px solid var(--input-border);
      border-radius: 4px;
      font-family: 'Roboto Mono', monospace;
      font-size: 14px;
      outline: none;
    }
    .form-group input::placeholder, 
    .form-group select::placeholder {
      color: #aaa;
    }

    /********************************************
     6) BUTTONS
    ********************************************/
    .btn {
      padding: 10px 20px;
      margin: 5px 10px 5px 0;
      background: var(--button-bg-color);
      color: var(--button-text-color);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      text-transform: uppercase;
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
    }
    .btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 8px rgba(0, 255, 209, 0.3);
    }
    .button-container {
      text-align: center;
      margin: 20px 0;
    }

    /********************************************
     7) OUTPUT: SCR MESSAGES
    ********************************************/
    .output-container {
      margin-top: 20px;
      padding: 20px;
      background: var(--output-bg);
      border: 1px dashed var(--output-border);
      border-radius: 4px;
      white-space: pre-wrap;
      font-family: 'Roboto Mono', monospace;
      color: var(--heading-color);
      line-height: 1.5;
    }
    .output-container .heading {
      text-transform: uppercase;
      margin-bottom: 10px;
      color: var(--heading-color);
      font-family: 'Orbitron', sans-serif;
      font-size: 1.1rem;
    }

    /* Additional styling for the displayed SCR messages */
    .scr-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .scr-info-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .airport-code {
      font-weight: bold;
      font-size: 1rem;
      font-family: 'Orbitron', sans-serif;
      color: var(--primary-color);
    }
    .button-group {
      display: flex;
      gap: 5px;
    }

    .scr-message {
      display: none;
      margin-bottom: 20px;
      padding: 10px;
      background: var(--output-bg);
      border: 1px dashed var(--output-border);
      border-radius: 4px;
      white-space: pre-wrap;
      font-family: 'Roboto Mono', monospace;
      color: var(--heading-color);
      line-height: 1.5;
    }

    .requests-container {
      margin-bottom: 40px;
      position: relative; /* to position the delete button in corner if desired */
    }
    .requests-container h2 {
      font-size: 1rem;
      margin: 10px 0;
    }

    /* The remove button for each request pair */
    .remove-request-btn {
      position: absolute;
      top: 0;
      right: 0;
      padding: 5px 10px;
      background: #ff5555;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      font-family: 'Orbitron', sans-serif;
      text-transform: uppercase;
    }
    .remove-request-btn:hover {
      background: #cc0000;
      transform: scale(1.05);
    }

    @media (max-width: 600px) {
      nav ul {
        flex-direction: column;
      }
      .form-row {
        flex-direction: column;
      }
      .remove-request-btn {
        top: 40px;
      }
    }
  </style>
</head>
<body>
  <!-- NAV BAR -->
  <nav>
    <ul>
      <li><a href="index.html">Single Flight</a></li>
      <li><a href="multiflight.html">Multi Flight</a></li>
      <li><a href="scrchangerequest.html">SCR Change</a></li>
      <li><a href="historic-log.html">Historic Log</a></li>
      <li><a href="airport-search.html">Airport DB</a></li>
      <li><a href="gcrformat.html">GCR Format</a></li>
      <li><a href="https://forms.gle/nXCQzWxCcH5B1uZd6">Log Issues</a></li>
    </ul>
    <!-- Theme Switch -->
    <div class="theme-switch">
      <label for="themeToggle">Dark Mode</label>
      <input type="checkbox" id="themeToggle" aria-label="Toggle Dark Mode">
    </div>
  </nav>

  <!-- Main Container -->
  <div class="container">
    <h1>SCR Change Message Requests</h1>

    <!-- Where all pairs of forms will be placed -->
    <div id="formsWrapper"></div>

    <!-- Button container for adding / resetting / showing message -->
    <div class="button-container">
      <button class="btn" id="addFormsBtn">Add More Requests</button>
      <button class="btn" id="resetBtn">Reset</button>
      <button class="btn" id="showSCRBtn">Show SCR Messages</button>
    </div>

    <!-- Container to hold the SCR messages -->
    <div id="outputList" class="output-container">
      <div class="heading">SCR Messages</div>
      <!-- SCR messages appended here -->
    </div>
  </div>

  <!-- Hidden template for the pair of forms -->
  <template id="formsTemplate">
    <div class="requests-container">
      <!-- Remove button for this specific form pair -->
      <button class="remove-request-btn" type="button">Delete</button>

      <h2>Request #</h2>

      <h2>Old Request</h2>
      <form class="old-request-form">
        <div class="form-row">
          <div class="form-group">
            <label>Slot</label>
            <select required name="slotType">
              <option value="" disabled selected>-</option>
              <option value="Arrival">Arrival</option>
              <option value="Departure">Departure</option>
            </select>
          </div>
          <div class="form-group">
            <label>Airport</label>
            <input type="text" name="airport" placeholder="DUB">
          </div>
          <div class="form-group">
            <label>Flight</label>
            <input type="text" name="flightNo" placeholder="FR123">
          </div>
          <div class="form-group">
            <label>Date</label>
            <input type="date" name="date">
          </div>
          <div class="form-group">
            <label>Seats</label>
            <input type="number" name="seats" placeholder="189">
          </div>
          <div class="form-group">
            <label>A/C</label>
            <input type="text" name="acType" placeholder="73H">
          </div>
          <div class="form-group">
            <label>Time</label>
            <input type="text" name="time" placeholder="2000">
          </div>
          <div class="form-group">
            <label>D/O</label>
            <input type="text" name="do" placeholder="STN">
          </div>
          <div class="form-group">
            <label>STC</label>
            <select required name="stc">
              <option value="" disabled selected>-</option>
              <option value="P">P</option>
              <option value="D">D</option>
              <option value="T">T</option>
              <option value="K">K</option>
              <option value="J">J</option>
              <option value="X">X</option>  
            </select>
          </div>
        </div>
      </form>

      <h2>New Request</h2>
      <form class="new-request-form">
        <div class="form-row">
          <div class="form-group">
            <label>Slot</label>
            <select required name="slotType">
              <option value="" disabled selected>-</option>
              <option value="Arrival">Arrival</option>
              <option value="Departure">Departure</option>
            </select>
          </div>
          <div class="form-group">
            <label>Airport</label>
            <input type="text" name="airport" placeholder="DUB">
          </div>
          <div class="form-group">
            <label>Flight</label>
            <input type="text" name="flightNo" placeholder="FR123">
          </div>
          <div class="form-group">
            <label>Date</label>
            <input type="date" name="date">
          </div>
          <div class="form-group">
            <label>Seats</label>
            <input type="number" name="seats" placeholder="189">
          </div>
          <div class="form-group">
            <label>A/C</label>
            <input type="text" name="acType" placeholder="73H">
          </div>
          <div class="form-group">
            <label>Time</label>
            <input type="text" name="time" placeholder="2100">
          </div>
          <div class="form-group">
            <label>D/O</label>
            <input type="text" name="do" placeholder="STN">
          </div>
          <div class="form-group">
            <label>STC</label>
            <select required name="stc">
              <option value="" disabled selected>-</option>
              <option value="P">P</option>
              <option value="D">D</option>
              <option value="T">T</option>
              <option value="K">K</option>
              <option value="J">J</option>
            </select>
          </div>
        </div>
      </form>
    </div>
  </template>

  <script>
    /********************************************
     THEME TOGGLE
    ********************************************/
    const themeToggle = document.getElementById('themeToggle');
    const body = document.body;
    const savedTheme = localStorage.getItem('theme') || 'light';

    function applyTheme(theme) {
      if (theme === 'dark') {
        body.classList.add('dark-mode');
        themeToggle.checked = true;
      } else {
        body.classList.remove('dark-mode');
        themeToggle.checked = false;
      }
    }
    applyTheme(savedTheme);

    themeToggle.addEventListener('change', () => {
      if (themeToggle.checked) {
        localStorage.setItem('theme', 'dark');
        applyTheme('dark');
      } else {
        localStorage.setItem('theme', 'light');
        applyTheme('light');
      }
    });

    /********************************************
     MAIN SCRIPT
    ********************************************/
    const formsWrapper = document.getElementById('formsWrapper');
    const addFormsBtn = document.getElementById('addFormsBtn');
    const resetBtn = document.getElementById('resetBtn');
    const showSCRBtn = document.getElementById('showSCRBtn');
    const formsTemplate = document.getElementById('formsTemplate');
    const outputList = document.getElementById('outputList');

    let requestCount = 0; 
    let emailData = {};

    // Load emails.json
    async function fetchEmails() {
      try {
        const response = await fetch('assets/emails.json');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        emailData = data;
      } catch (error) {
        console.error('Error fetching emails.json:', error);
        alert('Failed to load email data. Email functionality may be limited.');
      }
    }

    // On page load
    window.addEventListener('DOMContentLoaded', () => {
      addFormsPair(); // add the first pair by default
      fetchEmails();
    });

    addFormsBtn.addEventListener('click', addFormsPair);
    resetBtn.addEventListener('click', () => {
      formsWrapper.innerHTML = '';
      outputList.innerHTML   = '<div class="heading">SCR Messages</div>';
      requestCount = 0;
      addFormsPair(); // re-add a fresh pair
    });

    showSCRBtn.addEventListener('click', () => {
      outputList.innerHTML = '<div class="heading">SCR Messages</div>';
      const containers = formsWrapper.querySelectorAll('.requests-container');
      if (containers.length === 0) {
        outputList.innerHTML += 'No forms available.';
        return;
      }
      containers.forEach((container) => {
        const oldForm = container.querySelector('.old-request-form');
        const newForm = container.querySelector('.new-request-form');
        if (!oldForm || !newForm) return;

        // Extract data
        const oldData = getFormData(oldForm);
        const newData = getFormData(newForm);

        // Validate
        if (!validateFormData(oldData, newData)) {
          alert('Please fill out all required fields.');
          return;
        }

        // Build SCR
        const scrMessage = buildSCRMessage(oldData, newData);
        const airportCode = oldData.airport || '???';

        // Create row + hidden message
        const rowDiv = document.createElement('div');
        rowDiv.classList.add('scr-row');

        const infoLeftDiv = document.createElement('div');
        infoLeftDiv.classList.add('scr-info-left');

        const airportSpan = document.createElement('span');
        airportSpan.classList.add('airport-code');
        airportSpan.textContent = airportCode;
        infoLeftDiv.appendChild(airportSpan);

        const buttonGroup = document.createElement('div');
        buttonGroup.classList.add('button-group');

        // Email Button
        const emailBtn = document.createElement('button');
        emailBtn.classList.add('btn');
        emailBtn.textContent = 'Email';
        emailBtn.addEventListener('click', () => {
          sendEmail(airportCode, scrMessage);
        });

        // Toggle Button
        const toggleBtn = document.createElement('button');
        toggleBtn.classList.add('btn');
        toggleBtn.textContent = '+';

        // The hidden message
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('scr-message');
        msgDiv.textContent = scrMessage;

        // Toggle show/hide
        toggleBtn.addEventListener('click', () => {
          if (msgDiv.style.display === 'none' || !msgDiv.style.display) {
            msgDiv.style.display = 'block';
            toggleBtn.textContent = '-';
          } else {
            msgDiv.style.display = 'none';
            toggleBtn.textContent = '+';
          }
        });

        buttonGroup.appendChild(emailBtn);
        buttonGroup.appendChild(toggleBtn);

        rowDiv.appendChild(infoLeftDiv);
        rowDiv.appendChild(buttonGroup);

        outputList.appendChild(rowDiv);
        outputList.appendChild(msgDiv);
      });
    });

    function addFormsPair() {
      requestCount++;
      const clone = formsTemplate.content.cloneNode(true);
      const containerElem = clone.querySelector('.requests-container');

      // Title
      const heading = containerElem.querySelector('h2');
      if (heading) {
        heading.textContent = `Request #${requestCount}`;
      }

      // Remove button
      const removeBtn = containerElem.querySelector('.remove-request-btn');
      removeBtn.addEventListener('click', () => {
        containerElem.remove();
      });

      // Uppercase on text inputs
      const textInputs = containerElem.querySelectorAll('input[type="text"]');
      textInputs.forEach(input => {
        input.addEventListener('input', () => {
          input.value = input.value.toUpperCase();
        });
      });

      // Sync slot type between old & new
      const oldSlotTypeSelect = containerElem.querySelector('.old-request-form select[name="slotType"]');
      const newSlotTypeSelect = containerElem.querySelector('.new-request-form select[name="slotType"]');
      if (oldSlotTypeSelect && newSlotTypeSelect) {
        // copy value if user changes old
        oldSlotTypeSelect.addEventListener('change', (event) => {
          newSlotTypeSelect.value = event.target.value;
        });
      }

      formsWrapper.appendChild(containerElem);
    }

    function getFormData(formEl) {
      const slotType = formEl.querySelector('select[name="slotType"]')?.value || '';
      const airport  = formEl.querySelector('input[name="airport"]')?.value.trim() || '';
      const flightNo = formEl.querySelector('input[name="flightNo"]')?.value.trim() || '';
      const date     = formEl.querySelector('input[name="date"]')?.value || '';
      const seats    = formEl.querySelector('input[name="seats"]')?.value || '';
      const acType   = formEl.querySelector('input[name="acType"]')?.value.trim() || '';
      const time     = formEl.querySelector('input[name="time"]')?.value.trim() || '';
      const doField  = formEl.querySelector('input[name="do"]')?.value.trim() || '';
      const stc      = formEl.querySelector('select[name="stc"]')?.value || '';
      return { slotType, airport, flightNo, date, seats, acType, time, doField, stc };
    }

    function validateFormData(oldReq, newReq) {
      // define required fields
      const requiredFields = ['slotType', 'airport', 'flightNo', 'date', 'seats', 'acType', 'time', 'doField', 'stc'];
      for (let field of requiredFields) {
        if (!oldReq[field] || !newReq[field]) {
          return false;
        }
      }
      return true;
    }

    function buildSCRMessage(oldReq, newReq) {
      const seasonCode      = 'W24'; 
      const oldReqDateDDMMM = formatDateToDDMMM(oldReq.date) || '01JAN';
      const oldReqAirport   = oldReq.airport || 'XXX';

      const lineSCR     = 'SCR';
      const lineSeason  = seasonCode;
      const lineDate    = oldReqDateDDMMM;
      const lineAirport = oldReqAirport;

      const lineOld = buildRequestLine('C', oldReq);
      const lineNew = buildRequestLine('R', newReq);
      const lineSI  = `SI SLOT CHG REQ ${oldReqAirport}`;

      return [
        lineSCR,
        lineSeason,
        lineDate,
        lineAirport,
        lineOld,
        lineNew,
        '',
        lineSI
      ].join('\n');
    }

    function buildRequestLine(prefix, req) {
      // prefix + flightNo
      let flightId;
      if (req.slotType === 'Arrival') {
        flightId = prefix + (req.flightNo || '');
      } else {
        flightId = prefix + ' ' + (req.flightNo || '');
      }

      const dateDDMMM  = formatDateToDDMMM(req.date) || '25DEC';
      const doCode     = getDayOfOperationCode(req.date);

      // default to "000" + acType
      let acTypeCode = '000' + (req.acType.replace(/\s/g, '') || '');
      // If STC is "D", override to "LJ4"
      if (req.stc === 'D') {
        acTypeCode = 'LJ4';
      }

      // station + time depends on Arrival/Departure
      let stationTimeSegment;
      if (req.slotType === 'Arrival') {
        stationTimeSegment = (req.doField || '') + (req.time || '');
      } else {
        stationTimeSegment = (req.time || '') + (req.doField || '');
      }

      return [
        flightId,
        dateDDMMM + dateDDMMM,
        doCode,
        acTypeCode,
        stationTimeSegment,
        req.stc
      ].join(' ');
    }

    function formatDateToDDMMM(isoDate) {
      if (!isoDate) return '';
      const [yyyy, mm, dd] = isoDate.split('-');
      if (!yyyy || !mm || !dd) return '';
      const monthNames = [
        'JAN','FEB','MAR','APR','MAY','JUN',
        'JUL','AUG','SEP','OCT','NOV','DEC'
      ];
      const monthIndex = parseInt(mm, 10) - 1;
      if (monthIndex < 0 || monthIndex > 11) return '';
      return dd + monthNames[monthIndex];
    }

    function getDayOfOperationCode(isoDate) {
      if (!isoDate) return '0000000';
      const jsDate = new Date(isoDate);
      if (isNaN(jsDate.getTime())) return '0000000';

      const dayIndex = jsDate.getDay(); // Sunday=0, Monday=1, ...
      const dayOfOperationMap = {
        0: '0000007',
        1: '1000000',
        2: '0200000',
        3: '0030000',
        4: '0004000',
        5: '0000500',
        6: '0000060'
      };
      return dayOfOperationMap[dayIndex] || '0000000';
    }

    function sendEmail(airportCode, scrMessage) {
      // If no email data for this airport, fail gracefully
      if (!emailData || !emailData[airportCode] || !emailData[airportCode].email) {
        alert(`No email address found for airport code: ${airportCode}. Please check emails.json.`);
        return;
      }
      const recipient = emailData[airportCode].email;
      const subject = `SLOT CHG REQ ${airportCode}`;
      const body = encodeURIComponent(scrMessage);
      const cc = 'slotdesk@ryanair.com';

      // Build mailto link
      const mailtoLink = `mailto:${recipient}?cc=${encodeURIComponent(cc)}&subject=${encodeURIComponent(subject)}&body=${body}`;

      // Simulate a click on an <a> to open the email client
      const a = document.createElement('a');
      a.href = mailtoLink;
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      alert(`Email client has been opened for ${airportCode}.`);
    }
  </script>
</body>
</html>
