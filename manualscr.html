<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>SCR Management System (New & Cancel Multiple Forms)</title>
  
  <!-- Google Fonts (Orbitron & Roboto Mono) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link 
    href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" 
    rel="stylesheet"
  />

  <style>
    /********************************************
     1) THEME VARIABLES: Light by default
     ********************************************/
    :root {
      /* Light Theme */
      --body-bg: #f5f5f5;
      --text-color: #333;
      --nav-bg: #fff;
      --nav-text-color: #333;
      --primary-color: #00FFD1;
      --secondary-color: #007BFF;
      --warning-bg: #ff0000;
      --warning-text: #fff;
      --container-bg: #fff;
      --border-color: #00FFD1;
      --input-bg: #fff;
      --input-border: #ccc;
      --output-bg: #f9f9f9;
      --output-border: #00FFD1;
      --button-bg-gradient: linear-gradient(90deg, #00FFD1 0%, #007BFF 100%);
      --button-text-color: #fff;
    }

    /* Dark Theme Override */
    body.dark-mode {
      --body-bg: #1a1a1a;
      --text-color: #eaeaea;
      --nav-bg: #2a2a2a;
      --nav-text-color: #f5f5f5;
      --warning-bg: #cc0000;
      --warning-text: #fff;
      --container-bg: #2e2e2e;
      --border-color: #00ffd1;
      --input-bg: #3a3a3a;
      --input-border: #555555;
      --output-bg: #1a1a1a;
      --output-border: #00ffd1;
      --button-bg-gradient: linear-gradient(90deg, #00FFD1 0%, #007BFF 100%);
      --button-text-color: #1a1a1a;
    }

    /********************************************
     2) GLOBAL RESET & SMOOTH TRANSITIONS
     ********************************************/
    * {
      box-sizing: border-box;
      transition: all 0.2s ease-in-out;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Orbitron', sans-serif;
      background-color: var(--body-bg);
      color: var(--text-color);
    }
    a {
      color: var(--text-color);
      text-decoration: none;
    }
    a:hover {
      color: var(--secondary-color);
    }

    /********************************************
     3) MOVING WARNING BAR
     ********************************************/
    .warning-bar {
      background-color: var(--warning-bg);
      color: var(--warning-text);
      font-size: 16px;
      font-weight: bold;
      text-align: center;
      overflow: hidden;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 9999;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
    }
    .warning-bar span {
      display: inline-block;
      padding-left: 100%;
      animation: scrollText 30s linear infinite;
      white-space: nowrap;
    }
    @keyframes scrollText {
      from { transform: translateX(0); }
      to   { transform: translateX(-100%); }
    }

    /********************************************
     4) NAVIGATION BAR
     ********************************************/
    nav {
      background-color: var(--nav-bg);
      color: var(--nav-text-color);
      padding: 10px 20px;
      border-bottom: 2px solid var(--border-color);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      margin-top: 50px; /* offset for warning bar */
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    nav ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    nav li {
      margin: 0;
      padding: 0;
    }
    nav a {
      color: var(--nav-text-color);
      text-decoration: none;
      font-size: 16px;
    }
    nav a:hover {
      color: var(--secondary-color);
    }
    /* Theme Toggle */
    .theme-switch {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    .theme-switch input {
      appearance: none;
      width: 40px;
      height: 20px;
      background-color: #ccc;
      border-radius: 20px;
      position: relative;
      outline: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .theme-switch input::before {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      background-color: #fff;
      border-radius: 50%;
      transition: transform 0.3s ease;
    }
    .theme-switch input:checked {
      background-color: var(--secondary-color);
    }
    .theme-switch input:checked::before {
      transform: translateX(20px);
    }

    /********************************************
     5) MAIN CONTAINER
     ********************************************/
    .container {
      max-width: 700px;
      margin: 60px auto;
      padding: 20px;
      background-color: var(--container-bg);
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0, 255, 209, 0.1);
      font-family: 'Orbitron', sans-serif;
    }
    .container h1 {
      text-transform: uppercase;
      text-align: center;
      color: var(--secondary-color);
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 1.8rem;
    }

    /********************************************
     6) BUTTONS, FORMS, LOG
     ********************************************/
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .btn-group button {
      padding: 10px 20px;
      background: var(--button-bg-gradient);
      color: var(--button-text-color);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      text-transform: uppercase;
      font-weight: 700;
    }
    .btn-group button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 8px rgba(0, 255, 209, 0.3);
    }

    #backToTop {
      display: none;
      padding: 10px 20px;
      background: var(--button-bg-gradient);
      color: var(--button-text-color);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 700;
      position: fixed;
      bottom: 20px;
      right: 20px;
    }
    #backToTop:hover {
      transform: scale(1.05);
      box-shadow: 0 0 8px rgba(0, 255, 209, 0.3);
    }

    /* Individual SCR form container */
    .scr-form {
      margin-top: 20px;
      padding: 10px;
      border: 1px dashed var(--border-color);
      border-radius: 6px;
      position: relative;
      font-family: 'Roboto Mono', monospace;
      background-color: var(--output-bg);
    }
    .scr-form h3 {
      color: var(--primary-color);
      font-size: 1.2rem;
      margin-top: 0;
      margin-bottom: 10px;
      text-transform: uppercase;
    }
    .remove-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #ff5555;
      border: none;
      border-radius: 4px;
      color: #fff;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }
    .remove-btn:hover {
      background: #cc0000;
      transform: scale(1.05);
    }
    .form-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    .form-group label {
      flex: 1;
      font-size: 0.9rem;
      font-weight: bold;
    }
    .form-group input,
    .form-group select {
      flex: 2;
      padding: 8px;
      font-size: 0.9rem;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 4px;
      color: var(--text-color);
      font-family: 'Roboto Mono', monospace;
    }
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--border-color);
      box-shadow: 0 0 4px rgba(0, 255, 209, 0.3);
    }
    .scrOutput {
      margin-top: 10px;
      padding: 10px;
      background: var(--container-bg);
      border: 1px dashed var(--output-border);
      border-radius: 4px;
      white-space: pre-wrap;
      color: var(--secondary-color);
      font-size: 0.9rem;
      display: none;
    }

    /* Log section */
    .log-section {
      margin-top: 30px;
      text-align: left;
    }
    .log-section h3 {
      color: var(--primary-color);
      margin-bottom: 10px;
      font-size: 1.2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-family: 'Roboto Mono', monospace;
    }
    table th,
    table td {
      padding: 10px;
      border: 1px solid var(--input-border);
    }
    table th {
      background-color: var(--nav-bg);
      color: var(--nav-text-color);
    }
    table tr:nth-child(even) {
      background-color: var(--output-bg);
    }

    /********************************************
     7) MEDIA QUERIES
     ********************************************/
    @media (max-width: 600px) {
      nav ul {
        flex-direction: column;
      }
      .theme-switch {
        margin-top: 10px;
      }
      .form-group {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- MOVING WARNING BAR -->
  <div class="warning-bar">
    <span>TESTING PHASE USE WITH CAUTION. DOUBLE CHECK BEFORE SENDING..... PLEASE MANUALLY ENTER IN GENERAL AVIATION EMAIL FOR LEARJETS IF REQUIRED</span>
  </div>

  <!-- NAVIGATION BAR -->
  <nav>
    <ul>
      <li><a href="index.html">Single Flight</a></li>
      <li><a href="multiflight.html">Multi Flight</a></li>
      <li><a href="scrchangerequest.html">SCR Change</a></li>
      <li><a href="historic-log.html">Historic Log</a></li>
      <li><a href="airport-search.html">Airport DB</a></li>
      <li><a href="gcrformat.html">GCR Format</a></li>
      <li><a href="quicklinks.html">Quick Links</a></li>
      <li><a href="https://forms.gle/nXCQzWxCcH5B1uZd6">Log Issues</a></li>
    </ul>

    <!-- Theme Toggle -->
    <div class="theme-switch">
      <label for="themeToggle">Dark Mode</label>
      <input type="checkbox" id="themeToggle" aria-label="Toggle Dark Mode">
    </div>
  </nav>

  <!-- MAIN CONTAINER -->
  <div class="container">
    <h1>SCR Management System</h1>

    <div class="btn-group">
      <!-- We have two separate buttons: Add NEW Slot Form / Add CANCEL Slot Form -->
      <button type="button" onclick="addNewSlotForm()">Add NEW Slot Form</button>
      <button type="button" onclick="addCancelSlotForm()">Add CANCEL Slot Form</button>
      <button type="button" onclick="showLog()">Log</button>
      <button id="backToTop" type="button" onclick="scrollToTop()">Back to Top</button>
    </div>

    <!-- All forms will be injected here -->
    <div id="formsContainer"></div>

    <!-- LOG SECTION -->
    <div id="logContainer" class="log-section" style="display: none;">
      <h3>Message Log</h3>
      <table id="logTable">
        <thead>
          <tr>
            <th>Slot Action</th>
            <th>SCR Message</th>
          </tr>
        </thead>
        <tbody>
          <!-- Filled by showSCR() calls -->
        </tbody>
      </table>
      <button type="button" onclick="downloadCSV()">Download CSV</button>
    </div>
  </div>

  <!-- TEMPLATES -->
  <!-- Template for "NEW SLOT" form -->
  <template id="newSlotTemplate">
    <div class="scr-form" data-slot-action="NEW">
      <button class="remove-btn" type="button" onclick="removeForm(this)">Remove Form</button>
      <h3>NEW SLOT</h3>
      
      <div class="form-group">
        <label>Slot Type:</label>
        <select class="slotType">
          <option value="ARRIVAL">ARRIVAL</option>
          <option value="DEPARTURE">DEPARTURE</option>
        </select>
      </div>

      <div class="form-group">
        <label>Airport (3 Letters):</label>
        <input type="text" class="airportCode" maxlength="3" placeholder="e.g. VLC" required />
      </div>

      <div class="form-group">
        <label>Flight No.:</label>
        <input type="text" class="flightNumber" placeholder="e.g., FR6060" required />
      </div>

      <div class="form-group">
        <label>Date:</label>
        <input type="date" class="dateField" required />
      </div>

      <div class="form-group">
        <label>Seats:</label>
        <input type="number" class="numberOfSeats" placeholder="e.g., 189" oninput="validateSeats(this)" required />
      </div>

      <div class="form-group">
        <label>Aircraft:</label>
        <input type="text" class="aircraftType" placeholder="e.g., 73H" required />
      </div>

      <div class="form-group">
        <label>Time:</label>
        <input type="text" class="timeField" maxlength="4" placeholder="e.g., 0725" required />
      </div>

      <div class="form-group">
        <label>Dest/Orig:</label>
        <input type="text" class="destinationOrigin" placeholder="e.g., MAD" required />
      </div>

      <div class="form-group">
        <label>Service:</label>
        <select class="serviceType" required>
          <option value="P">P</option>
          <option value="J">J</option>
          <option value="D">D</option>
          <option value="K">K</option>
          <option value="X">X</option>
        </select>
      </div>

      <div class="btn-group" style="justify-content: flex-start;">
        <button type="button" onclick="showSCR(this)">Show SCR</button>
        <button type="button" onclick="emailSCR(this)">Email SCR</button>
      </div>

      <div class="scrOutput"></div>
    </div>
  </template>

  <!-- Template for "CANCEL SLOT" form -->
  <template id="cancelSlotTemplate">
    <div class="scr-form" data-slot-action="CANCEL">
      <button class="remove-btn" type="button" onclick="removeForm(this)">Remove Form</button>
      <h3>CANCEL SLOT</h3>
      
      <div class="form-group">
        <label>Slot Type:</label>
        <select class="slotType">
          <option value="ARRIVAL">ARRIVAL</option>
          <option value="DEPARTURE">DEPARTURE</option>
        </select>
      </div>

      <div class="form-group">
        <label>Airport (3 Letters):</label>
        <input type="text" class="airportCode" maxlength="3" placeholder="e.g. VLC" required />
      </div>

      <div class="form-group">
        <label>Flight No.:</label>
        <input type="text" class="flightNumber" placeholder="e.g., FR6060" required />
      </div>

      <div class="form-group">
        <label>Date:</label>
        <input type="date" class="dateField" required />
      </div>

      <div class="form-group">
        <label>Seats:</label>
        <input type="number" class="numberOfSeats" placeholder="e.g., 189" oninput="validateSeats(this)" required />
      </div>

      <div class="form-group">
        <label>Aircraft:</label>
        <input type="text" class="aircraftType" placeholder="e.g., 73H" required />
      </div>

      <div class="form-group">
        <label>Time:</label>
        <input type="text" class="timeField" maxlength="4" placeholder="e.g., 0725" required />
      </div>

      <div class="form-group">
        <label>Dest/Orig:</label>
        <input type="text" class="destinationOrigin" placeholder="e.g., MAD" required />
      </div>

      <div class="form-group">
        <label>Service:</label>
        <select class="serviceType" required>
          <option value="P">P</option>
          <option value="J">J</option>
          <option value="D">D</option>
          <option value="K">K</option>
          <option value="X">X</option>
        </select>
      </div>

      <div class="btn-group" style="justify-content: flex-start;">
        <button type="button" onclick="showSCR(this)">Show SCR</button>
        <button type="button" onclick="emailSCR(this)">Email SCR</button>
      </div>

      <div class="scrOutput"></div>
    </div>
  </template>

  <!-- SCRIPT -->
  <script>
    /******************************************
     THEME TOGGLE LOGIC
    ******************************************/
    const themeToggle = document.getElementById('themeToggle');
    const body = document.body;

    // Load saved theme
    const savedTheme = localStorage.getItem('theme') || 'light';
    applyTheme(savedTheme);

    function applyTheme(theme) {
      if (theme === 'dark') {
        body.classList.add('dark-mode');
        themeToggle.checked = true;
      } else {
        body.classList.remove('dark-mode');
        themeToggle.checked = false;
      }
    }

    themeToggle.addEventListener('change', () => {
      if (themeToggle.checked) {
        localStorage.setItem('theme', 'dark');
        applyTheme('dark');
      } else {
        localStorage.setItem('theme', 'light');
        applyTheme('light');
      }
    });

    /******************************************
     GLOBAL DATA
    ******************************************/
    let logData = [];
    // If you have a JSON with airport emails:
    let airportEmails = {};

    // Optional: fetch your JSON for emails
    async function loadEmailData() {
      // For example:
      // const response = await fetch('assets/emails.json');
      // airportEmails = await response.json();
      // console.log("Loaded airport emails:", airportEmails);
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadEmailData();
    });

    /******************************************
     ADD / REMOVE FORM LOGIC
    ******************************************/
    function addNewSlotForm() {
      const template = document.getElementById('newSlotTemplate');
      const clone = template.content.cloneNode(true);
      document.getElementById('formsContainer').appendChild(clone);
    }

    function addCancelSlotForm() {
      const template = document.getElementById('cancelSlotTemplate');
      const clone = template.content.cloneNode(true);
      document.getElementById('formsContainer').appendChild(clone);
    }

    function removeForm(removeButton) {
      // removeButton is inside .scr-form
      const formDiv = removeButton.closest('.scr-form');
      if (formDiv) {
        formDiv.remove();
      }
    }

    /******************************************
     BACK TO TOP
    ******************************************/
    window.onscroll = function () {
      const backToTopButton = document.getElementById('backToTop');
      if (document.documentElement.scrollTop > 200 || document.body.scrollTop > 200) {
        backToTopButton.style.display = 'block';
      } else {
        backToTopButton.style.display = 'none';
      }
    };

    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    /******************************************
     FIELD VALIDATION (Seats)
    ******************************************/
    function validateSeats(input) {
      if (input.value.length > 3) {
        input.value = input.value.slice(0, 3);
      }
    }

    /******************************************
     GET DAY VALUE
    ******************************************/
    function getDayValue(dateObj) {
      const dayValues = {
        Sunday: '0000007',
        Monday: '1000000',
        Tuesday: '0200000',
        Wednesday: '0030000',
        Thursday: '0004000',
        Friday: '0000500',
        Saturday: '0000060'
      };
      const dayName = new Intl.DateTimeFormat('en-US', { weekday: 'long' }).format(dateObj);
      return dayValues[dayName] || '0000000';
    }

    /******************************************
     SHOW SCR (PER-FORM)
    ******************************************/
    function showSCR(buttonEl) {
      // Find parent .scr-form
      const formDiv = buttonEl.closest('.scr-form');
      if (!formDiv) return;

      // 'NEW' or 'CANCEL' from data-slot-action attribute
      const slotAction = formDiv.getAttribute('data-slot-action') || 'NEW';
      
      const slotType = formDiv.querySelector('.slotType').value;
      const airportCode = formDiv.querySelector('.airportCode').value.trim().toUpperCase();
      const flightNumber = formDiv.querySelector('.flightNumber').value.trim();
      const dateInput = formDiv.querySelector('.dateField').value;
      const seats = formDiv.querySelector('.numberOfSeats').value.padStart(3, '0');
      const aircraftType = formDiv.querySelector('.aircraftType').value.trim().toUpperCase();
      const time = formDiv.querySelector('.timeField').value.padStart(4, '0');
      const destOrig = formDiv.querySelector('.destinationOrigin').value.trim().toUpperCase();
      const service = formDiv.querySelector('.serviceType').value;

      if (!airportCode || !flightNumber || !dateInput || !seats || !aircraftType || !time || !destOrig) {
        alert('Please fill in all fields.');
        return;
      }

      const dateObj = new Date(dateInput);
      if (isNaN(dateObj)) {
        alert('Invalid date format.');
        return;
      }

      // Decide the indicator: 'N' for new, 'D' for cancel
      let actionIndicator = 'C'; // default to 'C' for safety
      if (slotAction === 'NEW') {
        actionIndicator = 'N';
      } else if (slotAction === 'CANCEL') {
        actionIndicator = 'D';
      }

      const dayValue = getDayValue(dateObj);
      const day = dateObj.getDate().toString().padStart(2, '0');
      const monthNames = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
      const month = monthNames[dateObj.getMonth()];
      const formattedDate = `${day}${month}`;

      // For final display, let's store a text label
      let actionText = slotAction === 'NEW' ? 'NEW SLOT' : 'CANCEL SLOT';

      // Build SCR
      let scr = `SCR  
W24  
${formattedDate}  
${airportCode}  
`;

      if (slotType === 'ARRIVAL') {
        scr += `${actionIndicator}${flightNumber} ${formattedDate}${formattedDate} ${dayValue} ${seats}${aircraftType} ${destOrig}${time} ${service}  
SI ${actionText} REQ ${airportCode}`;
      } else {
        // DEPARTURE
        scr += `${actionIndicator} ${flightNumber} ${formattedDate}${formattedDate} ${dayValue} ${seats}${aircraftType} ${time}${destOrig} ${service}  
SI ${actionText} REQ ${airportCode}`;
      }

      // Display in form
      const outputEl = formDiv.querySelector('.scrOutput');
      outputEl.textContent = scr.trim();
      outputEl.style.display = 'block';

      // Add to global log
      logData.push({
        slotAction: actionText,
        scrMessage: scr.trim()
      });
      console.log('SCR generated:', scr.trim());
    }

    /******************************************
     EMAIL SCR (PER-FORM)
    ******************************************/
    function emailSCR(buttonEl) {
      // Find parent .scr-form
      const formDiv = buttonEl.closest('.scr-form');
      if (!formDiv) return;

      const outputEl = formDiv.querySelector('.scrOutput');
      const scrMessage = outputEl.textContent.trim();
      if (!scrMessage) {
        alert('No SCR message to email. Generate it first.');
        return;
      }

      // Grab the airport code from the form
      const airportCode = formDiv.querySelector('.airportCode').value.trim().toUpperCase();
      // Example: if you have loaded airportEmails[airportCode]
      const emailList = airportEmails[airportCode]?.email || 'slotdesk@ryanair.com';
      const ccEmail = 'slotdesk@ryanair.com';

      // Derive subject from the form's heading or the first lines
      const headingText = formDiv.querySelector('h3')?.textContent.toUpperCase() || 'SCR REQUEST';
      let subject = headingText.includes('CANCEL') 
        ? `CANCEL SLOT REQ ${airportCode}` 
        : `NEW SLOT REQ ${airportCode}`;

      const mailtoLink = `mailto:${emailList}?cc=${encodeURIComponent(ccEmail)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(scrMessage)}`;
      window.location.href = mailtoLink;
    }

    /******************************************
     SHOW LOG
    ******************************************/
    function showLog() {
      const logContainer = document.getElementById('logContainer');
      const logTableBody = document.querySelector('#logTable tbody');
      logTableBody.innerHTML = ''; // Clear old data

      if (logData.length === 0) {
        logContainer.style.display = 'none';
        alert('No log data available.');
        return;
      }

      logData.forEach(item => {
        const row = logTableBody.insertRow();
        const cellAction = row.insertCell(0);
        const cellMessage = row.insertCell(1);
        cellAction.textContent = item.slotAction;
        cellMessage.textContent = item.scrMessage;
      });

      logContainer.style.display = 'block';
      logContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    /******************************************
     DOWNLOAD CSV
    ******************************************/
    function downloadCSV() {
      if (logData.length === 0) {
        alert('No log data available to download.');
        return;
      }

      const csvRows = [
        ['Slot Action', 'SCR Message'],
        ...logData.map((item) => [
          item.slotAction,
          item.scrMessage.replace(/\n/g, ' '),
        ])
      ];

      const csvContent = csvRows
        .map((row) => row.map((field) => `"${field.replace(/"/g, '""')}"`).join(','))
        .join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', 'scr_log.csv');
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
